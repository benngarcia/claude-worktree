#!/usr/bin/env bash
set -e

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    echo "âŒ Error: You have uncommitted changes. Please commit or stash them before deploying."
    exit 1
fi

echo "ğŸš€ Starting deployment sequence..."
echo "This will: "
echo "  1. Tag the current version in git"
echo "  2. Push commits and tags to remote"
echo "  3. Build the gem"
echo "  4. Push to RubyGems"
echo ""

# Confirm
read -p "Are you sure you want to release? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 1
fi

bundle exec rake release

# Get the version that was just released
VERSION=$(ruby -r./lib/claude/worktree/version -e 'puts Claude::Worktree::VERSION')
GEM_URL="https://rubygems.org/downloads/claude-worktree-${VERSION}.gem"

echo ""
echo "âœ… Gem released successfully!"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“¦ Homebrew Update Instructions"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "1. Wait a minute for RubyGems to propagate, then get the SHA256:"
echo ""
echo "   curl -sL ${GEM_URL} | shasum -a 256"
echo ""
echo "2. Update your Homebrew tap formula with:"
echo "   - version \"${VERSION}\""
echo "   - sha256 \"<sha from step 1>\""
echo ""
echo "3. Commit and push the formula update."
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
